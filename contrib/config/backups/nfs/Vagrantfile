# -*- mode: ruby -*-
# vi: set ft=ruby :
eval File.read("./vagrant/helper.rb")

Vagrant.configure("2") do |config|
  @hosts.each do |hostname, ipaddr|
    default = if hostname == @primary then true else false end
    autostart = @starts.include? hostname
    config.vm.define hostname, autostart: autostart, primary: default do |node|
      node.vm.box = "generic/ubuntu1804"
      node.vm.hostname = "#{hostname}"
      node.vm.network "private_network", ip: ipaddr
      node.vm.synced_folder ".", "/vagrant"

      node.vm.provider "virtualbox" do |vbox, override|
        vbox.name = "#{hostname}"
        # enable SMB3.0 for better fileshare UX on Windows-Virtualbox
        if Vagrant::Util::Platform.windows? then
          override.vm.synced_folder  ".", "/vagrant", @smb_sync_opts
        end
      end

      ## Configure /vagrant/env.sh on guest (useful sync_folder not used)
      if hostname =~ /nfs-client/ then
        node.trigger.after :up do |trigger|
          trigger.name = "Configure Guest '/vagrant/env.sh'"
          trigger.run_remote = {
            inline: <<-SCRIPT
              echo "## Configuration generated by Vagrant" > /vagrant/env.sh
              echo "NFS_PATH='/srv/share'" >> /vagrant/env.sh
              echo "NFS_SERVER='#{@hosts['nfs-server']}'" >> /vagrant/env.sh
            SCRIPT
          }
        end
      end

      ## Configure Host 'env.sh' on host system (useful if vagrant client not used)
      node.trigger.after :up do |trigger|
        trigger.name = "Configure host 'env.sh'"
        trigger.ruby do |env,machine|
          File.open('env.sh', 'w') do |file|
            file << <<~HEREDOC
              ## Configuration generated by Vagrant
              export NFS_PATH="/srv/share"
              export NFS_SERVER="#{ipaddr}"
            HEREDOC
          end
        end
      end

      node.vm.provider "hyperv" do |hyperv, override|
        hyperv.vmname = "#{hostname}"
        # enable SMB3.0 for better fileshare UX on Windows-HyperV
        override.vm.synced_folder  ".", "/vagrant", @smb_sync_opts
      end

    end
  end
end
